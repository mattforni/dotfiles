exports.id=449,exports.ids=[449],exports.modules={1848:(t,e,r)=>{r.r(e),r.d(e,{GitLabApi:()=>GitLabApi});var a=r(9496),n=r(1177),s=r(7338),i=r(4575),o=r(8452),l=r(4092),u=r(7925),c=r(5148),d=r(4241),h=r(4336),g=r(8227),p=r(6004),m=r(6398),w=r(4627),f=r(6630),b=Object.defineProperty,q=Object.getOwnPropertyDescriptor,y=(t,e,r,a)=>{for(var n,s=a>1?void 0:a?q(e,r):e,i=t.length-1;i>=0;i--)(n=t[i])&&(s=(a?n(e,r,s):n(s))||s);return a&&s&&b(e,r,s),s};class GitLabApi{constructor(t){this._projectIds=new Map,this._proxyAgents=new Map,this._disposable=c.D.onDidChangeAny((t=>{(c.D.changedAny(t,["http.proxy","http.proxyStrictSSL"])||c.D.changed(t,["proxy","remotes"]))&&this.resetCaches()}))}dispose(){this._disposable.dispose()}resetCaches(){this._projectIds.clear(),this._proxyAgents.clear()}getProxyAgent(t){if(s.$L)return;let e=this._proxyAgents.get(t.id);if(void 0===e){const r=t.getIgnoreSSLErrors();e=(0,n.Nx)(!0!==r&&"force"!==r&&void 0),this._proxyAgents.set(t.id,e??null)}return e??void 0}async getAccountForCommit(t,e,r,n,s,o){const l=(0,p.UH)(),u=await this.getProjectId(t,e,r,n,o?.baseUrl);if(u)try{const r=await this.request(t,e,o?.baseUrl,`v4/projects/${u}/repository/commits/${s}?stats=false`,{method:"GET"},l);let n;const i=await this.findUser(t,e,r.author_name,o);for(const t of i)if(t.name===r.author_name||t.publicEmail&&t.publicEmail===r.author_email){if(n=t,"active"===t.state)break}else((0,w.qq)(t.name,r.author_name)||t.publicEmail&&(0,w.qq)(t.publicEmail,r.author_email))&&(n=t);if(null==n)return;return n.avatarUrl&&!/^([a-zA-Z][\w+.-]+):/.test(n.avatarUrl)&&(n.avatarUrl=a.Uri.joinPath(a.Uri.parse(n.webUrl),"..",n.avatarUrl).toString()),{provider:t,name:n.name||void 0,email:r.author_email||void 0,avatarUrl:n.avatarUrl||void 0}}catch(e){if(e instanceof i.Ww)return;throw this.handleException(e,t,l)}}async getAccountForEmail(t,e,r,a,n,s){const o=(0,p.UH)();try{const[r]=await this.findUser(t,e,n,s);if(null==r)return;return{provider:t,name:r.name||void 0,email:r.publicEmail||void 0,avatarUrl:r.avatarUrl||void 0}}catch(e){if(e instanceof i.Ww)return;throw this.handleException(e,t,o)}}async getDefaultBranch(t,e,r,a,n){const s=(0,p.UH)();try{const i="query getDefaultBranch(\n\t$fullPath: ID!\n) {\n\tproject(fullPath: $fullPath) {\n\t\trepository {\n\t\t\trootRef\n\t\t}\n}",o=await this.graphql(t,e,n?.baseUrl,i,{fullPath:`${r}/${a}`},s),l=o?.data?.project?.repository?.rootRef??void 0;if(null==l)return;return{provider:t,name:l}}catch(e){if(e instanceof i.Ww)return;throw this.handleException(e,t,s)}}async getIssueOrPullRequest(t,e,r,a,n,s){const l=(0,p.UH)();try{const i="query getIssueOrMergeRequest(\n\t$fullPath: ID!\n\t$iid: String!\n) {\n\tproject(fullPath: $fullPath) {\n\t\tmergeRequest(iid: $iid) {\n\t\t\tauthor {\n\t\t\t\tname\n\t\t\t\tavatarUrl\n\t\t\t\twebUrl\n\t\t\t}\n\t\t\tiid\n\t\t\ttitle\n\t\t\tdescription\n\t\t\tstate\n\t\t\tcreatedAt\n\t\t\tupdatedAt\n\t\t\tmergedAt\n\t\t\twebUrl\n\t\t}\n\t\tissue(iid: $iid) {\n\t\t\tauthor {\n\t\t\t\tname\n\t\t\t\tavatarUrl\n\t\t\t\twebUrl\n\t\t\t}\n\t\t\tiid\n\t\t\ttitle\n\t\t\tdescription\n\t\t\tstate\n\t\t\tcreatedAt\n\t\t\tupdatedAt\n\t\t\tclosedAt\n\t\t\twebUrl\n\t\t}\n\t}\n}",u=await this.graphql(t,e,s?.baseUrl,i,{fullPath:`${r}/${a}`,iid:String(n)},l);if(null!=u?.data?.project?.issue){const e=u.data.project.issue;return{provider:t,type:o.mX.Issue,id:e.iid,date:new Date(e.createdAt),title:e.title,closed:"closed"===e.state,closedDate:null==e.closedAt?void 0:new Date(e.closedAt),url:e.webUrl}}if(null!=u?.data?.project?.mergeRequest){const e=u.data.project.mergeRequest;return{provider:t,type:o.mX.PullRequest,id:e.iid,date:new Date(e.createdAt),title:e.title,closed:"closed"===e.state,closedDate:"closed"===e.state?new Date(e.updatedAt):void 0,url:e.webUrl}}return}catch(e){if(e instanceof i.Ww)return;throw this.handleException(e,t,l)}}async getPullRequestForBranch(t,e,r,a,n,s){const o=(0,p.UH)();try{const i="\n\t\t\tnodes {\n\t\t\t\tiid\n\t\t\t\tauthor {\n\t\t\t\t\tname\n\t\t\t\t\tavatarUrl\n\t\t\t\t\twebUrl\n\t\t\t\t}\n\t\t\t\ttitle\n\t\t\t\tdescription\n\t\t\t\tstate\n\t\t\t\tcreatedAt\n\t\t\t\tupdatedAt\n\t\t\t\tmergedAt\n\t\t\t\twebUrl\n\t\t\t}",u=`query getMergeRequestForBranch(\n\t$fullPath: ID!\n\t$branches: [String!]\n) {\n\tproject(fullPath: $fullPath) {\n\t\t${null==s?.include?`mergeRequests(sourceBranches: $branches sort: UPDATED_DESC first: 1) {\n\t\t\t${i}\n\t\t}`:""}\n\t\t${s?.include?.includes(f.GitLabMergeRequestState.OPEN)?`opened: mergeRequests(sourceBranches: $branches state: opened sort: UPDATED_DESC first: 1) {\n\t\t\t${i}\n\t\t}`:""}\n\t\t${s?.include?.includes(f.GitLabMergeRequestState.MERGED)?`merged: mergeRequests(sourceBranches: $branches state: merged sort: UPDATED_DESC first: 1) {\n\t\t\t${i}\n\t\t}`:""}\n\t\t${s?.include?.includes(f.GitLabMergeRequestState.CLOSED)?`closed: mergeRequests(sourceBranches: $branches state: closed sort: UPDATED_DESC first: 1) {\n\t\t\t${i}\n\t\t}`:""}\n\t}\n}`,c=await this.graphql(t,e,s?.baseUrl,u,{fullPath:`${r}/${a}`,branches:[n],state:s?.include},o);let d;if(null==s?.include)d=c?.data?.project?.mergeRequests?.nodes?.[0];else for(const t of s.include){let e;t===f.GitLabMergeRequestState.OPEN?e=c?.data?.project?.opened?.nodes?.[0]:t===f.GitLabMergeRequestState.MERGED?e=c?.data?.project?.merged?.nodes?.[0]:t===f.GitLabMergeRequestState.CLOSED&&(e=c?.data?.project?.closed?.nodes?.[0]),null!=e&&(null==d||new Date(e.updatedAt)>new Date(d.updatedAt))&&(d=e)}if(null==d)return;return new l.i7(t,{name:d.author?.name??"Unknown",avatarUrl:d.author?.avatarUrl??"",url:d.author?.webUrl??""},String(d.iid),d.title,d.webUrl,(0,f.fromGitLabMergeRequestState)(d.state),new Date(d.updatedAt),d.state!==f.GitLabMergeRequestState.CLOSED?void 0:new Date(d.updatedAt),null==d.mergedAt?void 0:new Date(d.mergedAt))}catch(e){if(e instanceof i.Ww)return;throw this.handleException(e,t,o)}}async getPullRequestForCommit(t,e,r,a,n,s){const o=(0,p.UH)(),l=await this.getProjectId(t,e,r,a,s?.baseUrl);if(l)try{const r=await this.request(t,e,s?.baseUrl,`v4/projects/${l}/repository/commits/${n}/merge_requests`,{method:"GET"},o);if(null==r||0===r.length)return;return r.length>1&&r.sort(((t,e)=>(t.state===f.GitLabMergeRequestState.OPEN?-1:1)-(e.state===f.GitLabMergeRequestState.OPEN?-1:1)||new Date(e.updated_at).getTime()-new Date(t.updated_at).getTime())),(0,f.fromGitLabMergeRequestREST)(r[0],t)}catch(e){if(e instanceof i.Ww)return;throw this.handleException(e,t,o)}}async findUser(t,e,r,a){const n=(0,p.UH)();try{const s="query findUser(\n$search: String!\n) {\n\tusers(search: $search) {\n\t\tnodes {\n\t\t\tid\n\t\t\tname\n\t\t\tusername,\n\t\t\tpublicEmail,\n\t\t\tstate\n\t\t\tavatarUrl\n\t\t\twebUrl\n\t\t}\n\t}\n}",i=await this.graphql(t,e,a?.baseUrl,s,{search:r},n),o=i?.data?.users?.nodes;if(null==o||0===o.length)return[];const l=[];for(const t of o){const e=/gid:\/\/gitlab\/User\/([0-9]+)\b/.exec(t.id);null!=e&&l.push({id:parseInt(e[1],10),name:t.name,username:t.username,publicEmail:t.publicEmail||void 0,state:t.state,avatarUrl:t.avatarUrl,webUrl:t.webUrl})}return l}catch(e){return e instanceof i.Ww||this.handleException(e,t,n),[]}}getProjectId(t,e,r,a,n){const s=`${e}|${r}/${a}`;let i=this._projectIds.get(s);return null==i&&(i=this.getProjectIdCore(t,e,r,a,n),this._projectIds.set(s,i)),i}async getProjectIdCore(t,e,r,a,n){const s=(0,p.UH)();try{const i="query getProjectId(\n\t$fullPath: ID!\n) {\n\tproject(fullPath: $fullPath) {\n\t\tid\n\t}\n}",o=await this.graphql(t,e,n,i,{fullPath:`${r}/${a}`},s),l=o?.data?.project?.id;if(null==l)return;const u=/gid:\/\/gitlab\/Project\/([0-9]+)\b/.exec(l);if(null==u)return;const c=u[1];return(0,p.lH)(s,` â€¢ projectId=${c}`),c}catch(e){if(e instanceof i.Ww)return;return void this.handleException(e,t,s)}}async graphql(t,e,r,s,o,l){let u;try{const a=h.Yd.logLevel===g.i.Debug||h.Yd.isDebugging?new m.u(`[GITLAB] POST ${r}`,{log:!1}):void 0,l=this.getProxyAgent(t);try{if(u=await(0,n.a_)(t.getIgnoreSSLErrors(),(()=>(0,n.he)(`${r??"https://gitlab.com/api"}/graphql`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},agent:l,body:JSON.stringify({query:s,variables:o})}))),u.ok){const t=await u.json();if("errors"in t)throw new i.Xq("GitLab",u,t.errors);return t}throw new i.Xq("GitLab",u)}finally{const t=/(^[^({\n]+)/.exec(s),e=` ${t?.[1].trim()??s}`;a?.stop({message:e})}}catch(r){throw r instanceof i.Xq?this.handleRequestError(t,e,r,l):h.Yd.isDebugging&&a.window.showErrorMessage(`GitLab request failed: ${r.message}`),r}}async request(t,e,r,s,o,l){const u=`${r??"https://gitlab.com/api"}/${s}`;let c;try{const r=h.Yd.logLevel===g.i.Debug||h.Yd.isDebugging?new m.u(`[GITLAB] ${o?.method??"GET"} ${u}`,{log:!1}):void 0,a=this.getProxyAgent(t);try{if(c=await(0,n.a_)(t.getIgnoreSSLErrors(),(()=>(0,n.he)(u,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},agent:a,...o}))),c.ok){return await c.json()}throw new i.Xq("GitLab",c)}finally{r?.stop()}}catch(r){throw r instanceof i.Xq?this.handleRequestError(t,e,r,l):h.Yd.isDebugging&&a.window.showErrorMessage(`GitLab request failed: ${r.message}`),r}}handleRequestError(t,e,r,n){switch(r.status){case 404:case 410:case 422:throw new i.Ww(r);case 401:throw new i._7("gitlab",i.Jx.Unauthorized,r);case 403:if(r.message.includes("rate limit exceeded")){let t;const a=r.response?.headers?.get("x-ratelimit-reset");throw null!=a&&(t=parseInt(a,10),Number.isNaN(t)&&(t=void 0)),new i.yx(r,e,t)}throw new i._7("gitlab",i.Jx.Forbidden,r);case 500:return h.Yd.error(r,n),void(null!=r.response&&(t?.trackRequestException(),(0,u.vF)(`${t?.name??"GitLab"} failed to respond and might be experiencing issues.${t?.custom?"":" Please visit the [GitLab status page](https://status.gitlab.com) for more information."}`)));case 502:if(h.Yd.error(r,n),r.message.includes("timeout"))return t?.trackRequestException(),void(0,u.s$)(t?.name??"GitLab");break;default:if(r.status>=400&&r.status<500)throw new i.Bn(r)}h.Yd.error(r,n),h.Yd.isDebugging&&a.window.showErrorMessage(`GitLab request failed: ${r.response?.errors?.[0]?.message??r.message}`)}handleException(t,e,r){return h.Yd.error(t,r),t instanceof i._7&&this.showAuthenticationErrorMessage(t,e),t}async showAuthenticationErrorMessage(t,e){if(t.reason===i.Jx.Unauthorized||t.reason===i.Jx.Forbidden){const r="Reauthenticate";await a.window.showErrorMessage(`${t.message}. Would you like to try reauthenticating${t.reason===i.Jx.Forbidden?" to provide additional access":""}?`,r)===r&&await e.reauthenticate()}else a.window.showErrorMessage(t.message)}}y([(0,d.fF)({args:{0:t=>t.name,1:"<token>"}})],GitLabApi.prototype,"getAccountForCommit",1),y([(0,d.fF)({args:{0:t=>t.name,1:"<token>"}})],GitLabApi.prototype,"getAccountForEmail",1),y([(0,d.fF)({args:{0:t=>t.name,1:"<token>"}})],GitLabApi.prototype,"getDefaultBranch",1),y([(0,d.fF)({args:{0:t=>t.name,1:"<token>"}})],GitLabApi.prototype,"getIssueOrPullRequest",1),y([(0,d.fF)({args:{0:t=>t.name,1:"<token>"}})],GitLabApi.prototype,"getPullRequestForBranch",1),y([(0,d.fF)({args:{0:t=>t.name,1:"<token>"}})],GitLabApi.prototype,"getPullRequestForCommit",1)},6630:(t,e,r)=>{r.r(e),r.d(e,{GitLabMergeRequestState:()=>n,fromGitLabMergeRequestREST:()=>o,fromGitLabMergeRequestState:()=>s,toGitLabMergeRequestState:()=>i});var a=r(4092),n=(t=>(t.OPEN="opened",t.CLOSED="closed",t.MERGED="merged",t.LOCKED="locked",t))(n||{});function s(t){return"merged"===t?a.o0.Merged:"closed"===t||"locked"===t?a.o0.Closed:a.o0.Open}function i(t){return t===a.o0.Merged?"merged":t===a.o0.Closed?"closed":"opened"}function o(t,e){return new a.i7(e,{name:t.author?.name??"Unknown",avatarUrl:t.author?.avatar_url??"",url:t.author?.web_url??""},String(t.iid),t.title,t.web_url,s(t.state),new Date(t.updated_at),null==t.closed_at?void 0:new Date(t.closed_at),null==t.merged_at?void 0:new Date(t.merged_at))}}};