exports.id=449,exports.ids=[449],exports.modules={1848:(t,e,r)=>{r.r(e),r.d(e,{GitLabApi:()=>GitLabApi});var a=r(9496),n=r(1177),s=r(7338),o=r(4575),i=r(8452),l=r(4092),c=r(7925),u=r(5148),d=r(4241),h=r(4336),p=r(6004),g=r(6398),m=r(4627),f=r(6630),w=Object.defineProperty,b=Object.getOwnPropertyDescriptor,y=(t,e,r,a)=>{for(var n,s=a>1?void 0:a?b(e,r):e,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(a?n(e,r,s):n(s))||s);return a&&s&&w(e,r,s),s};class GitLabApi{_disposable;_projectIds=new Map;constructor(t){this._disposable=u.D.onDidChangeAny((t=>{(u.D.changedAny(t,["http.proxy","http.proxyStrictSSL"])||u.D.changed(t,["proxy","remotes"]))&&this.resetCaches()}))}dispose(){this._disposable.dispose()}resetCaches(){this._projectIds.clear(),this._proxyAgents.clear()}_proxyAgents=new Map;getProxyAgent(t){if(s.$L)return;let e=this._proxyAgents.get(t.id);if(void 0===e){const r=t.getIgnoreSSLErrors();e=(0,n.Nx)(!0!==r&&"force"!==r&&void 0),this._proxyAgents.set(t.id,e??null)}return e??void 0}async getAccountForCommit(t,e,r,n,s,i){const l=(0,p.UH)(),c=await this.getProjectId(t,e,r,n,i?.baseUrl);if(c)try{const r=await this.request(t,e,i?.baseUrl,`v4/projects/${c}/repository/commits/${s}?stats=false`,{method:"GET"},l);let n;const o=await this.findUser(t,e,r.author_name,i);for(const t of o)if(t.name===r.author_name||t.publicEmail&&t.publicEmail===r.author_email){if(n=t,"active"===t.state)break}else((0,m.qq)(t.name,r.author_name)||t.publicEmail&&(0,m.qq)(t.publicEmail,r.author_email))&&(n=t);if(null==n)return;return n.avatarUrl&&!/^([a-zA-Z][\w+.-]+):/.test(n.avatarUrl)&&(n.avatarUrl=a.Uri.joinPath(a.Uri.parse(n.webUrl),"..",n.avatarUrl).toString()),{provider:t,name:n.name||void 0,email:r.author_email||void 0,avatarUrl:n.avatarUrl||void 0}}catch(e){if(e instanceof o.Ww)return;throw this.handleException(e,t,l)}}async getAccountForEmail(t,e,r,a,n,s){const i=(0,p.UH)();try{const[r]=await this.findUser(t,e,n,s);if(null==r)return;return{provider:t,name:r.name||void 0,email:r.publicEmail||void 0,avatarUrl:r.avatarUrl||void 0}}catch(e){if(e instanceof o.Ww)return;throw this.handleException(e,t,i)}}async getDefaultBranch(t,e,r,a,n){const s=(0,p.UH)();try{const o="query getDefaultBranch(\n\t$fullPath: ID!\n) {\n\tproject(fullPath: $fullPath) {\n\t\trepository {\n\t\t\trootRef\n\t\t}\n}",i=await this.graphql(t,e,n?.baseUrl,o,{fullPath:`${r}/${a}`},s),l=i?.data?.project?.repository?.rootRef??void 0;if(null==l)return;return{provider:t,name:l}}catch(e){if(e instanceof o.Ww)return;throw this.handleException(e,t,s)}}async getIssueOrPullRequest(t,e,r,a,n,s){const l=(0,p.UH)();try{const o="query getIssueOrMergeRequest(\n\t$fullPath: ID!\n\t$iid: String!\n) {\n\tproject(fullPath: $fullPath) {\n\t\tmergeRequest(iid: $iid) {\n\t\t\tauthor {\n\t\t\t\tname\n\t\t\t\tavatarUrl\n\t\t\t\twebUrl\n\t\t\t}\n\t\t\tiid\n\t\t\ttitle\n\t\t\tdescription\n\t\t\tstate\n\t\t\tcreatedAt\n\t\t\tupdatedAt\n\t\t\tmergedAt\n\t\t\twebUrl\n\t\t}\n\t\tissue(iid: $iid) {\n\t\t\tauthor {\n\t\t\t\tname\n\t\t\t\tavatarUrl\n\t\t\t\twebUrl\n\t\t\t}\n\t\t\tiid\n\t\t\ttitle\n\t\t\tdescription\n\t\t\tstate\n\t\t\tcreatedAt\n\t\t\tupdatedAt\n\t\t\tclosedAt\n\t\t\twebUrl\n\t\t}\n\t}\n}",c=await this.graphql(t,e,s?.baseUrl,o,{fullPath:`${r}/${a}`,iid:String(n)},l);if(null!=c?.data?.project?.issue){const e=c.data.project.issue;return{provider:t,type:i.mX.Issue,id:e.iid,date:new Date(e.createdAt),title:e.title,closed:"closed"===e.state,closedDate:null==e.closedAt?void 0:new Date(e.closedAt),url:e.webUrl}}if(null!=c?.data?.project?.mergeRequest){const e=c.data.project.mergeRequest;return{provider:t,type:i.mX.PullRequest,id:e.iid,date:new Date(e.createdAt),title:e.title,closed:"closed"===e.state,closedDate:"closed"===e.state?new Date(e.updatedAt):void 0,url:e.webUrl}}return}catch(e){if(e instanceof o.Ww)return;throw this.handleException(e,t,l)}}async getPullRequestForBranch(t,e,r,a,n,s){const i=(0,p.UH)();try{const o="\n\t\t\tnodes {\n\t\t\t\tiid\n\t\t\t\tauthor {\n\t\t\t\t\tname\n\t\t\t\t\tavatarUrl\n\t\t\t\t\twebUrl\n\t\t\t\t}\n\t\t\t\ttitle\n\t\t\t\tdescription\n\t\t\t\tstate\n\t\t\t\tcreatedAt\n\t\t\t\tupdatedAt\n\t\t\t\tmergedAt\n\t\t\t\twebUrl\n\t\t\t}",c=`query getMergeRequestForBranch(\n\t$fullPath: ID!\n\t$branches: [String!]\n) {\n\tproject(fullPath: $fullPath) {\n\t\t${null==s?.include?`mergeRequests(sourceBranches: $branches sort: UPDATED_DESC first: 1) {\n\t\t\t${o}\n\t\t}`:""}\n\t\t${s?.include?.includes(f.GitLabMergeRequestState.OPEN)?`opened: mergeRequests(sourceBranches: $branches state: opened sort: UPDATED_DESC first: 1) {\n\t\t\t${o}\n\t\t}`:""}\n\t\t${s?.include?.includes(f.GitLabMergeRequestState.MERGED)?`merged: mergeRequests(sourceBranches: $branches state: merged sort: UPDATED_DESC first: 1) {\n\t\t\t${o}\n\t\t}`:""}\n\t\t${s?.include?.includes(f.GitLabMergeRequestState.CLOSED)?`closed: mergeRequests(sourceBranches: $branches state: closed sort: UPDATED_DESC first: 1) {\n\t\t\t${o}\n\t\t}`:""}\n\t}\n}`,u=await this.graphql(t,e,s?.baseUrl,c,{fullPath:`${r}/${a}`,branches:[n],state:s?.include},i);let d;if(null==s?.include)d=u?.data?.project?.mergeRequests?.nodes?.[0];else for(const t of s.include){let e;t===f.GitLabMergeRequestState.OPEN?e=u?.data?.project?.opened?.nodes?.[0]:t===f.GitLabMergeRequestState.MERGED?e=u?.data?.project?.merged?.nodes?.[0]:t===f.GitLabMergeRequestState.CLOSED&&(e=u?.data?.project?.closed?.nodes?.[0]),null!=e&&(null==d||new Date(e.updatedAt)>new Date(d.updatedAt))&&(d=e)}if(null==d)return;return new l.i7(t,{name:d.author?.name??"Unknown",avatarUrl:d.author?.avatarUrl??"",url:d.author?.webUrl??""},String(d.iid),d.title,d.webUrl,(0,f.fromGitLabMergeRequestState)(d.state),new Date(d.updatedAt),d.state!==f.GitLabMergeRequestState.CLOSED?void 0:new Date(d.updatedAt),null==d.mergedAt?void 0:new Date(d.mergedAt))}catch(e){if(e instanceof o.Ww)return;throw this.handleException(e,t,i)}}async getPullRequestForCommit(t,e,r,a,n,s){const i=(0,p.UH)(),l=await this.getProjectId(t,e,r,a,s?.baseUrl);if(l)try{const r=await this.request(t,e,s?.baseUrl,`v4/projects/${l}/repository/commits/${n}/merge_requests`,{method:"GET"},i);if(null==r||0===r.length)return;return r.length>1&&r.sort(((t,e)=>(t.state===f.GitLabMergeRequestState.OPEN?-1:1)-(e.state===f.GitLabMergeRequestState.OPEN?-1:1)||new Date(e.updated_at).getTime()-new Date(t.updated_at).getTime())),(0,f.fromGitLabMergeRequestREST)(r[0],t)}catch(e){if(e instanceof o.Ww)return;throw this.handleException(e,t,i)}}async getRepositoryMetadata(t,e,r,a,n){const s=(0,p.UH)(),i=await this.getProjectId(t,e,r,a,n?.baseUrl);if(i)try{const r=await this.request(t,e,n?.baseUrl,`v4/projects/${i}`,{method:"GET"},s);if(null==r)return;return{provider:t,owner:r.namespace.full_path,name:r.path,isFork:null!=r.forked_from_project,parent:null!=r.forked_from_project?{owner:r.forked_from_project.namespace.full_path,name:r.forked_from_project.path}:void 0}}catch(e){if(e instanceof o.Ww)return;throw this.handleException(e,t,s)}}async findUser(t,e,r,a){const n=(0,p.UH)();try{const s="query findUser(\n$search: String!\n) {\n\tusers(search: $search) {\n\t\tnodes {\n\t\t\tid\n\t\t\tname\n\t\t\tusername,\n\t\t\tpublicEmail,\n\t\t\tstate\n\t\t\tavatarUrl\n\t\t\twebUrl\n\t\t}\n\t}\n}",o=await this.graphql(t,e,a?.baseUrl,s,{search:r},n),i=o?.data?.users?.nodes;if(null==i||0===i.length)return[];const l=[];for(const t of i){const e=/gid:\/\/gitlab\/User\/([0-9]+)\b/.exec(t.id);null!=e&&l.push({id:parseInt(e[1],10),name:t.name,username:t.username,publicEmail:t.publicEmail||void 0,state:t.state,avatarUrl:t.avatarUrl,webUrl:t.webUrl})}return l}catch(e){return e instanceof o.Ww||this.handleException(e,t,n),[]}}getProjectId(t,e,r,a,n){const s=`${e}|${r}/${a}`;let o=this._projectIds.get(s);return null==o&&(o=this.getProjectIdCore(t,e,r,a,n),this._projectIds.set(s,o)),o}async getProjectIdCore(t,e,r,a,n){const s=(0,p.UH)();try{const o="query getProjectId(\n\t$fullPath: ID!\n) {\n\tproject(fullPath: $fullPath) {\n\t\tid\n\t}\n}",i=await this.graphql(t,e,n,o,{fullPath:`${r}/${a}`},s),l=i?.data?.project?.id;if(null==l)return;const c=/gid:\/\/gitlab\/Project\/([0-9]+)\b/.exec(l);if(null==c)return;const u=c[1];return(0,p.lH)(s,` â€¢ projectId=${u}`),u}catch(e){if(e instanceof o.Ww)return;return void this.handleException(e,t,s)}}async graphql(t,e,r,s,i,l){let c;try{const a=(0,g.k)(`[GITLAB] POST ${r}`,{log:!1}),l=this.getProxyAgent(t);try{if(c=await(0,n.a_)(t.getIgnoreSSLErrors(),(()=>(0,n.he)(`${r??"https://gitlab.com/api"}/graphql`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},agent:l,body:JSON.stringify({query:s,variables:i})}))),c.ok){const t=await c.json();if("errors"in t)throw new o.Xq("GitLab",c,t.errors);return t}throw new o.Xq("GitLab",c)}finally{const t=/(^[^({\n]+)/.exec(s),e=` ${t?.[1].trim()??s}`;a?.stop({message:e})}}catch(r){throw r instanceof o.Xq?this.handleRequestError(t,e,r,l):h.Yd.isDebugging&&a.window.showErrorMessage(`GitLab request failed: ${r.message}`),r}}async request(t,e,r,s,i,l){const c=`${r??"https://gitlab.com/api"}/${s}`;let u;try{const r=(0,g.k)(`[GITLAB] ${i?.method??"GET"} ${c}`,{log:!1}),a=this.getProxyAgent(t);try{if(u=await(0,n.a_)(t.getIgnoreSSLErrors(),(()=>(0,n.he)(c,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},agent:a,...i}))),u.ok){return await u.json()}throw new o.Xq("GitLab",u)}finally{r?.stop()}}catch(r){throw r instanceof o.Xq?this.handleRequestError(t,e,r,l):h.Yd.isDebugging&&a.window.showErrorMessage(`GitLab request failed: ${r.message}`),r}}handleRequestError(t,e,r,n){switch(r.status){case 404:case 410:case 422:throw new o.Ww(r);case 401:throw new o._7("gitlab",o.Jx.Unauthorized,r);case 403:if(r.message.includes("rate limit exceeded")){let t;const a=r.response?.headers?.get("x-ratelimit-reset");throw null!=a&&(t=parseInt(a,10),Number.isNaN(t)&&(t=void 0)),new o.yx(r,e,t)}throw new o._7("gitlab",o.Jx.Forbidden,r);case 500:return h.Yd.error(r,n),void(null!=r.response&&(t?.trackRequestException(),(0,c.vF)(`${t?.name??"GitLab"} failed to respond and might be experiencing issues.${t?.custom?"":" Please visit the [GitLab status page](https://status.gitlab.com) for more information."}`)));case 502:if(h.Yd.error(r,n),r.message.includes("timeout"))return t?.trackRequestException(),void(0,c.s$)(t?.name??"GitLab");break;default:if(r.status>=400&&r.status<500)throw new o.Bn(r)}h.Yd.error(r,n),h.Yd.isDebugging&&a.window.showErrorMessage(`GitLab request failed: ${r.response?.errors?.[0]?.message??r.message}`)}handleException(t,e,r){return h.Yd.error(t,r),t instanceof o._7&&this.showAuthenticationErrorMessage(t,e),t}async showAuthenticationErrorMessage(t,e){if(t.reason===o.Jx.Unauthorized||t.reason===o.Jx.Forbidden){const r="Reauthenticate";await a.window.showErrorMessage(`${t.message}. Would you like to try reauthenticating${t.reason===o.Jx.Forbidden?" to provide additional access":""}?`,r)===r&&await e.reauthenticate()}else a.window.showErrorMessage(t.message)}}y([(0,d.fF)({args:{0:t=>t.name,1:"<token>"}})],GitLabApi.prototype,"getAccountForCommit",1),y([(0,d.fF)({args:{0:t=>t.name,1:"<token>"}})],GitLabApi.prototype,"getAccountForEmail",1),y([(0,d.fF)({args:{0:t=>t.name,1:"<token>"}})],GitLabApi.prototype,"getDefaultBranch",1),y([(0,d.fF)({args:{0:t=>t.name,1:"<token>"}})],GitLabApi.prototype,"getIssueOrPullRequest",1),y([(0,d.fF)({args:{0:t=>t.name,1:"<token>"}})],GitLabApi.prototype,"getPullRequestForBranch",1),y([(0,d.fF)({args:{0:t=>t.name,1:"<token>"}})],GitLabApi.prototype,"getPullRequestForCommit",1),y([(0,d.fF)({args:{0:t=>t.name,1:"<token>"}})],GitLabApi.prototype,"getRepositoryMetadata",1)},6630:(t,e,r)=>{r.r(e),r.d(e,{GitLabMergeRequestState:()=>n,fromGitLabMergeRequestREST:()=>i,fromGitLabMergeRequestState:()=>s,toGitLabMergeRequestState:()=>o});var a=r(4092),n=(t=>(t.OPEN="opened",t.CLOSED="closed",t.MERGED="merged",t.LOCKED="locked",t))(n||{});function s(t){return"merged"===t?a.o0.Merged:"closed"===t||"locked"===t?a.o0.Closed:a.o0.Open}function o(t){return t===a.o0.Merged?"merged":t===a.o0.Closed?"closed":"opened"}function i(t,e){return new a.i7(e,{name:t.author?.name??"Unknown",avatarUrl:t.author?.avatar_url??"",url:t.author?.web_url??""},String(t.iid),t.title,t.web_url,s(t.state),new Date(t.updated_at),null==t.closed_at?void 0:new Date(t.closed_at),null==t.merged_at?void 0:new Date(t.merged_at))}}};