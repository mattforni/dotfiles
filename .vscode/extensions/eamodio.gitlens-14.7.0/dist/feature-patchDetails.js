exports.id=537,exports.ids=[537],exports.modules={9804:(e,t,i)=>{i.d(t,{PatchDetailsWebviewProvider:()=>PatchDetailsWebviewProvider});var s=i(9496),a=i(8388),r=i(3016),o=i(5255),n=i(9558),c=i(439),h=i(7881),l=i(4321),d=i(3646),p=i(847),f=i(2509);async function u(e,t,i){if(null==i)return;let a=await (0,p.C_)(i,{});if(0===a.length)return;let r=s.window.createQuickPick();r.ignoreFocusOut=(0,f.hE)();let o=[];try{let i=await new Promise(i=>{o.push(r.onDidHide(()=>i(void 0)),r.onDidAccept(()=>{0!==r.activeItems.length&&i(r.activeItems[0])})),r.title=e,r.placeholder=t,r.matchOnDescription=!0,r.matchOnDetail=!0,r.items=a,r.show()});if(null==i)return;return i}finally{r.dispose(),o.forEach(e=>void e.dispose())}}async function g(e,t,i){let a;let r=s.window.createInputBox();r.ignoreFocusOut=!0;let o=[];try{a=await new Promise(i=>{o.push(r.onDidHide(()=>i(void 0)),r.onDidAccept(()=>{let e=r.value.trim();if(null==e){r.validationMessage="Please enter a valid branch name";return}i(e)})),r.title=e,r.placeholder=t,r.prompt="Enter a name for the new branch",r.show()})}finally{r.dispose(),o.forEach(e=>void e.dispose())}return a}async function m(e,t){if(null==t)return;let i={label:"Create new branch",description:"Creates a branch to apply the Cloud Patch to. (Typing an existing branch name will use that branch.)"},a={label:"Select existing branch",description:"Selects an existing branch to apply the Cloud Patch to."},r=[i,a],o=s.window.createQuickPick();o.ignoreFocusOut=(0,f.hE)();let n=[];try{let s=await new Promise(t=>{n.push(o.onDidHide(()=>t(void 0)),o.onDidAccept(()=>{0!==o.activeItems.length&&t(o.activeItems[0])})),o.title=e,o.placeholder="Select a branch option",o.matchOnDescription=!0,o.matchOnDetail=!0,o.items=r,o.show()});if(s===i)return g(e,"Enter a name for the new branch",t);if(s===a)return u(e,"Select an existing branch",t);return}finally{o.dispose(),n.forEach(e=>void e.dispose())}}var y=i(9529),w=i(5148),v=i(2061),C=i(4241),D=i(9796),b=i(3105),x=i(3700),_=i(7469),k=i(7387),S=i(5798),P=i(9679),R=i(4435);let F=new S.ke("patch/apply"),I=new S.ke("patch/create"),U=new S.ke("patch/openInGraph"),E=new S.ke("patch/checked");new S.ke("patch/selectRepo"),new S.ke("patch/selectBase"),new S.ke("patch/file/actions");let M=new S.ke("patch/file/open");new S.ke("patch/file/openOnRemote");let O=new S.ke("patch/file/compareWorking"),V=new S.ke("patch/file/comparePrevious"),W=new S.ke("patch/explain"),T=new S.ke("patch/preferences/update"),q=new S.ke("patch/switchMode"),A=new S.ke("patch/cloud/copyLink");new S.ke("patch/local/createPatch");let H=new S.ke("patch/create/repository/check"),$=new S.ke("patch/update/create/metadata"),L=new S.ke("patch/update/draft/metadata"),z=new S.ke("patch/update/draft/permissions"),N=new S.ke("patch/update/users"),j=new S.ke("patch/update/userSelection"),B=new S.jH("patch/didChange",!0),G=new S.jH("patch/create/didChange"),Q=new S.jH("patch/draft/didChange"),Y=new S.jH("patch/preferences/didChange"),Z=new S.jH("patch/didExplain"),J=new S.jH("patch/draft/didChangeRepository");let RepositoryRefChangeset=class RepositoryRefChangeset{constructor(e,t,i,s,a,r){this.container=e,this.repository=t,this.revision=i,this.files=s,this.checked=a,this.expanded=r}type="revision";dispose(){}suspend(){}resume(){}_checked=!1;get checked(){return this._checked}set checked(e){this._checked=e}_expanded=!1;get expanded(){return this._expanded}set expanded(e){this._expanded!==e&&(this._expanded=e)}async getChange(){return{type:"revision",repository:{name:this.repository.name,path:this.repository.path,uri:this.repository.uri.toString()},revision:this.revision,files:this.files,checked:this.checked,expanded:this.expanded}}};let RepositoryWipChangeset=class RepositoryWipChangeset{constructor(e,t,i,s,a,r){this.container=e,this.repository=t,this.revision=i,this.onDidChangeRepositoryWip=s,this.checked=a,this.expanded=r}type="wip";_disposable;dispose(){this._disposable?.dispose(),this._disposable=void 0}suspend(){this._disposable?.dispose(),this._disposable=void 0}resume(){this._files=void 0,this._expanded&&this.subscribe()}_checked=!1;get checked(){return this._checked}set checked(e){this._checked=e}_expanded=!1;get expanded(){return this._expanded}set expanded(e){this._expanded!==e&&(this._files=void 0,e?this.subscribe():(this._disposable?.dispose(),this._disposable=void 0),this._expanded=e)}_files;async getChange(){let e;return this.expanded&&(null==this._files&&(this._files=this.getFiles()),e=await this._files),{type:"wip",repository:{name:this.repository.name,path:this.repository.path,uri:this.repository.uri.toString()},revision:this.revision,files:e?.files,checked:this.checked,expanded:this.expanded}}subscribe(){null==this._disposable&&(this._disposable=s.Disposable.from(this.repository.watchFileSystem(1e3),this.repository.onDidChangeFileSystem(()=>this.onDidChangeWip(),this),this.repository.onDidChange(e=>{e.changed(d.I6.Index,d.du.Any)&&this.onDidChangeWip()})))}onDidChangeWip(){this._files=void 0,this.onDidChangeRepositoryWip(this)}async getFiles(){let e=await this.container.git.getStatusForRepo(this.repository.path),t=[];if(null!=e)for(let i of e.files){let e={repoPath:i.repoPath,path:i.path,status:i.status,originalPath:i.originalPath,staged:i.staged};t.push(e),i.staged&&i.wip&&t.push({...e,staged:!1})}return{files:t}}};var K=Object.defineProperty,X=Object.getOwnPropertyDescriptor;let PatchDetailsWebviewProvider=class PatchDetailsWebviewProvider{constructor(e,t){this.container=e,this.host=t,this._context={mode:"create",draft:void 0,draftUserState:void 0,draftVisibiltyState:void 0,create:void 0,preferences:this.getPreferences()},this.setHostTitle(),this.host.description="PREVIEW ☁️",this._disposable=s.Disposable.from(w.D.onDidChangeAny(this.onAnyConfigurationChanged,this),e.git.onDidChangeRepositories(this.onRepositoriesChanged,this))}_context;_disposable;dispose(){this._disposable.dispose()}canReuseInstance(...e){let[t]=e;if(t?.mode==="view"&&null!=t.draft)switch(t.draft.draftType){case"cloud":return this._context.draft?.draftType===t.draft.draftType&&this._context.draft.id===t.draft.id;case"local":return this._context.draft?.draftType===t.draft.draftType&&this._context.draft.patch.contents===t.draft.patch?.contents}return!1}async onShowing(e,t,...i){let[s]=i;if(s?.mode==="view"&&null!=s.draft)await this.updateViewDraftState(s.draft);else{this.container.git.isDiscoveringRepositories&&await this.container.git.isDiscoveringRepositories;let e=s?.mode==="create"&&null!=s.create?s.create:{repositories:void 0};this.updateCreateDraftState(e)}return!t?.preserveVisibility||!!this.host.visible}includeBootstrap(){return this.getState(this._context)}registerCommands(){return this.host.isView()?[(0,y.xR)(`${this.host.id}.refresh`,()=>this.host.refresh(!0)),(0,y.xR)(`${this.host.id}.close`,()=>this.closeView())]:[]}onMessageReceived(e){switch(e.method){case F.method:(0,S.mq)(F,e,e=>this.applyPatch(e));break;case A.method:(0,S.mq)(A,e,()=>this.copyCloudLink());break;case I.method:(0,S.mq)(I,e,e=>this.createDraft(e));break;case W.method:(0,S.mq)(W,e,()=>this.explainPatch(e.completionId));break;case V.method:(0,S.mq)(V,e,e=>void this.openFileComparisonWithPrevious(e));break;case O.method:(0,S.mq)(O,e,e=>void this.openFileComparisonWithWorking(e));break;case M.method:(0,S.mq)(M,e,e=>void this.openFile(e));break;case U.method:(0,S.mq)(U,e,e=>void(0,y.P0)(o.Gh.ShowInCommitGraph,{ref:(0,l.xB)(e.ref,e.repoPath,{refType:"revision"})}));break;case q.method:(0,S.mq)(q,e,e=>this.switchMode(e));break;case $.method:(0,S.mq)($,e,e=>this.updateCreateMetadata(e));break;case L.method:(0,S.mq)(L,e,e=>this.updateDraftMetadata(e));break;case z.method:(0,S.mq)(z,e,()=>this.updateDraftPermissions());break;case H.method:(0,S.mq)(H,e,e=>this.updateCreateCheckedState(e));break;case T.method:(0,S.mq)(T,e,e=>this.updatePreferences(e));break;case E.method:(0,S.mq)(E,e,e=>this.onPatchChecked(e));break;case N.method:(0,S.mq)(N,e,()=>this.onInviteUsers());break;case j.method:(0,S.mq)(j,e,e=>this.onUpdatePatchUserSelection(e))}}onRefresh(){this.updateState(!0)}onReloaded(){this.updateState(!0)}onVisibilityChanged(e){this._context.create?.changes.forEach(t=>e?t.resume():t.suspend()),e&&this.host.sendPendingIpcNotifications()}onAnyConfigurationChanged(e){(w.D.changed(e,["defaultDateFormat","views.patchDetails.files","views.patchDetails.avatars"])||w.D.changedCore(e,"workbench.tree.renderIndentGuides")||w.D.changedCore(e,"workbench.tree.indent"))&&(this._context.preferences={...this._context.preferences,...this.getPreferences()},this.updateState())}getPreferences(){return{avatars:w.D.get("views.patchDetails.avatars"),dateFormat:w.D.get("defaultDateFormat")??"MMMM Do, YYYY h:mma",files:w.D.get("views.patchDetails.files"),indentGuides:w.D.getCore("workbench.tree.renderIndentGuides")??"onHover",indent:w.D.getCore("workbench.tree.indent")}}onRepositoriesChanged(e){if("create"===this.mode&&null!=this._context.create){if(this._context.create?.showingAllRepos)for(let t of e.added)this._context.create.changes.set(t.uri.toString(),new RepositoryWipChangeset(this.container,t,{to:c.CL,from:"HEAD"},this.onRepositoryWipChanged.bind(this),!1,!0));for(let t of e.removed)this._context.create.changes.delete(t.uri.toString());this.notifyDidChangeCreateDraftState()}}onRepositoryWipChanged(e){this.notifyDidChangeCreateDraftState()}get mode(){return this._context.mode}setMode(e,t){this._context.mode=e,this.setHostTitle(e),(0,v.v)("gitlens:views:patchDetails:mode","editor"===w.D.get("cloudPatches.experimental.layout")?void 0:e),t||this.updateState(!0)}setHostTitle(e=this._context.mode){this.host.title="create"===e?"Create Cloud Patch":"Cloud Patch Details"}async applyPatch(e){if(null==this._context.draft||"local"===this._context.draft.draftType||!e.selected?.length)return;let t=this._context.draft.changesets?.[0];if(null==t)return;let i="branch"===e.target;for(let a of t.patches)if(e.selected.includes(a.id))try{let e;console.log(a);let t=a.commit;if(t||(t=await this.getOrCreateCommitForPatch(a.gkRepositoryId)),!t)continue;if(i){let i=t.getRepository(),r=await m(`Choose a Branch ${o.NE.Dot} ${i?.name}`,i);if(null==r){s.window.showErrorMessage(`Unable apply patch to '${a.repository.name}': No branch selected`);continue}let n="string"==typeof r;e={branchName:n?r:r.ref,createBranchIfNeeded:n}}this.container.git.applyUnreachableCommitForPatch(t.repoPath,t.ref,e)}catch(e){s.window.showErrorMessage(`Unable apply patch to '${a.baseRef}': ${e.message}`)}}closeView(){(0,v.v)("gitlens:views:patchDetails:mode",void 0)}copyCloudLink(){this._context.draft?.draftType==="cloud"&&s.env.clipboard.writeText(this._context.draft.deepLinkUrl)}async getOrganizationMembers(){let e=await this.container.subscription.getSubscription(!0),t=e?.activeOrganization;return null==t?[]:this.container.organizations.getOrganizationMembers(t.id)}async onInviteUsers(){let e;let t=null!=(e="create"===this.mode?this._context.create?.userSelections?.map(e=>e.member.id):this._context.draftUserState?.selections?.map(e=>e.member.id))?new Set(e):void 0,i=await this.selectCollaborators(t);if(null==i||0===i.length)return;if("create"===this.mode){let e=i.map(e=>ee(e,void 0,"editor","add"));null==this._context.create.userSelections?this._context.create.userSelections=e:this._context.create.userSelections.push(...e),this.notifyDidChangeCreateDraftState();return}let s=this._context.draftUserState,a=!1;for(let e of i)null==s.selections.find(t=>t.member.id===e.id)&&(a=!0,s.selections.push(ee(e,void 0,"editor","add")));a&&this.notifyDidChangeViewDraftState()}async selectCollaborators(e){let t=await this.getOrganizationMembers();if(0===t.length)return;let i=(0,_.PQ)(),o=[];try{let n=s.window.createQuickPick();o.push(n,n.onDidHide(()=>i.fulfill(void 0)),n.onDidAccept(()=>n.busy?void 0:i.fulfill(n.selectedItems.map(e=>e.item))),n.onDidTriggerButton(e=>{e===r.AI&&(n.canSelectMany?n.selectedItems=[]:i.fulfill([]))})),n.title="Select Collaborators",n.placeholder="Select the collaborators to share this patch with",n.matchOnDescription=!0,n.matchOnDetail=!0,n.canSelectMany=!0,n.buttons=[r.AI],n.busy=!0,n.show();let c=t.map(t=>({label:t.name,description:t.email,picked:!!e&&e.has(t.id),item:t,iconPath:(0,a.oP)(t.email,void 0)}));return n.items=c,n.busy=!1,await i.promise}finally{o.forEach(e=>void e.dispose())}}onUpdatePatchUserSelection(e){if("create"===this.mode){let t=this._context.create?.userSelections;if(null==t)return;if("remove"===e.role){let i=t.findIndex(t=>t.member.id===e.selection.member.id);if(-1===i)return;t.splice(i,1)}else{let i=t.find(t=>t.member.id===e.selection.member.id);if(null==i)return;i.pendingRole=e.role}this.notifyDidChangeCreateDraftState();return}let t=this._context.draftUserState.selections.find(t=>t.member.id===e.selection.member.id);null!=t&&("remove"===e.role?t.change="delete":(t.change="modify",t.pendingRole=e.role),this.notifyDidChangeViewDraftState())}async createDraft({title:e,changesets:t,description:i,visibility:a,userSelections:r}){if(!await (0,R.wz)("Cloud Patches require a GitKraken account.",this.container)||!await (0,R.FQ)(this.container))return;let o=[],n=Object.entries(t),h=1===n.length;for(let[e,t]of n){if(!h&&!1===t.checked)continue;let i=this._context.create?.changes?.get(e);if(null==i)continue;let{revision:s,repository:a}=i;"wip"===t.type&&"staged"===t.checked&&(s={...s,to:c.pw}),o.push({repository:a,revision:s})}if(null!=o)try{let t=await this.container.drafts.createDraft("patch",e,o,{description:i,visibility:a});null!=r&&0!==r.length&&await this.container.drafts.addDraftUsers(t.id,r.map(e=>({userId:e.member.id,role:e.pendingRole}))),async function(){let e={title:"View Patch"},i={title:"Copy Link"},a=!1;for(;;){let r=await s.window.showInformationMessage(`Cloud Patch successfully created${a?"— link copied to the clipboard":""}`,e,i);if(r===i){s.env.clipboard.writeText(t.deepLinkUrl),a=!0;continue}r===e&&(0,P.l)({mode:"view",draft:t});break}}(),this.container.draftsView.refresh(!0).then(()=>void this.container.draftsView.revealDraft(t)),this.closeView()}catch(e){s.window.showErrorMessage(`Unable to create draft: ${e.message}`)}}async explainPatch(e){let t;if(this._context.draft?.draftType==="cloud"){try{let e=await this.getDraftPatch(this._context.draft);if(null==e)throw Error("Unable to find patch");let i=await this.getOrCreateCommitForPatch(e.gkRepositoryId);if(null==i)throw Error("Unable to find commit");let s=await this.container.ai.explainCommit(i,{progress:{location:{viewId:this.host.id}}});if(null==s)throw Error("Error retrieving content");t={summary:s}}catch(e){t={error:{message:e.message}}}this.host.notify(Z,t,e)}}async openPatchContents(e){}async onPatchChecked(e){if(e.patch.repository.located||!1===e.checked)return;let t=this._context.draft?.changesets?.[0].patches?.find(t=>t.gkRepositoryId===e.patch.gkRepositoryId);if(t?.repository==null||(0,d.uC)(t.repository))return;let i=await this.container.repositoryIdentity.getRepository(t.repository,{openIfNeeded:!0,prompt:!0});null==i?s.window.showErrorMessage(`Unable to locate repository '${t.repository.name}'`):t.repository=i,this.notifyPatchRepositoryUpdated(t)}notifyPatchRepositoryUpdated(e){return this.host.notify(J,{patch:(0,k.q)({...e,contents:void 0,commit:void 0,repository:{id:e.gkRepositoryId,name:e.repository?.name??"",located:null!=e.repository&&(0,d.uC)(e.repository)}})})}updateCreateCheckedState(e){let t=this._context.create?.changes.get(e.repoUri);null!=t&&(t.checked=e.checked,this.notifyDidChangeCreateDraftState())}updateCreateMetadata(e){null!=this._context.create&&(this._context.create.title=e.title,this._context.create.description=e.description,this._context.create.visibility=e.visibility,this.notifyDidChangeCreateDraftState())}updateDraftMetadata(e){null!=this._context.draft&&(this._context.draftVisibiltyState=e.visibility,this.notifyDidChangeViewDraftState())}async updateDraftPermissions(){let e=this._context.draft,t=e.id,i=[];null!=this._context.draftVisibiltyState&&this._context.draftVisibiltyState!==e.visibility&&i.push(this.container.drafts.updateDraftVisibility(t,this._context.draftVisibiltyState));let a=this._context.draftUserState?.selections,r=[];if(null!=a)for(let e of a)void 0!==e.change&&("delete"!==e.change&&r.push({userId:e.member.id,role:e.pendingRole}),"add"!==e.change&&i.push(this.container.drafts.removeDraftUser(t,e.member.id)));(0!==i.length||0!==r.length)&&(0!==i.length&&console.log(await Promise.all(i)),0!==r.length&&await this.container.drafts.addDraftUsers(t,r),await this.createDraftUserState(e,{force:!0}),s.window.showInformationMessage("Cloud Patch successfully updated"),this.notifyDidChangeViewDraftState())}switchMode(e){this.setMode(e.mode)}_notifyDidChangeStateDebounced=void 0;updateState(e=!1){if(this.host.clearPendingIpcNotifications(),e){this.notifyDidChangeState();return}null==this._notifyDidChangeStateDebounced&&(this._notifyDidChangeStateDebounced=(0,D.Ds)(this.notifyDidChangeState.bind(this),500)),this._notifyDidChangeStateDebounced()}async getState(e){let t,i;return"create"===e.mode&&null!=e.create&&(t=await this.getCreateDraftState(e)),"view"===e.mode&&null!=e.draft&&(i=await this.getViewDraftState(e)),(0,k.q)({...this.host.baseWebviewState,mode:e.mode,create:t,draft:i,preferences:e.preferences})}async notifyDidChangeState(){return this._notifyDidChangeStateDebounced?.cancel(),this.host.notify(B,{state:await this.getState(this._context)})}updateCreateDraftState(e){let t;let i=!1;if(null!=e.changes){t=this._context.create?.changes??new Map;let i=new Set;for(let a of e.changes){let e;let r=this.container.git.getRepository(s.Uri.parse(a.repository.uri));null!=r&&(e="wip"===a.type?new RepositoryWipChangeset(this.container,r,a.revision,this.onRepositoryWipChanged.bind(this),a.checked??!0,a.expanded??!0):new RepositoryRefChangeset(this.container,r,a.revision,a.files,a.checked??!0,a.expanded??!0),i.add(r.uri.toString()),t.set(r.uri.toString(),e))}if(i.size!==t.size)for(let[e,s]of t)i.has(e)||(s.checked=!1)}else{i=null==e.repositories;let s=e.repositories??this.container.git.openRepositories;t=new Map(s.map(e=>[e.uri.toString(),new RepositoryWipChangeset(this.container,e,{to:c.CL,from:"HEAD"},this.onRepositoryWipChanged.bind(this),!0,!0)]))}this._context.create={title:e.title,description:e.description,changes:t,showingAllRepos:i,visibility:"public"},this.setMode("create",!0),this.notifyDidChangeCreateDraftState()}async getCreateDraftState(e){let{create:t}=e;if(null==t)return;let i={};if(0!==t.changes.size)for(let[e,s]of t.changes){let t=await s.getChange();t?.files?.length!==0&&(t.checked!==s.checked&&(t.checked=s.checked),i[e]=t)}return{title:t.title,description:t.description,changes:i,visibility:t.visibility,userSelections:t.userSelections}}async notifyDidChangeCreateDraftState(){return this.host.notify(G,{mode:this._context.mode,create:await this.getCreateDraftState(this._context)})}async updateViewDraftState(e){this._context.draft=e,e?.draftType==="cloud"&&await this.createDraftUserState(e,{force:!0}),this.setMode("view",!0),this.notifyDidChangeViewDraftState()}async getViewDraftState(e){if(null==e.draft)return;let t=e.draft;if("cloud"===t.draftType){(null==t.changesets||(0,b.G)(t.changesets,e=>e.patches.some(e=>null==e.contents||null==e.files||null==e.repository)))&&setTimeout(async()=>{null==t.changesets&&(t.changesets=await this.container.drafts.getChangesets(t.id));let e=t.changesets.flatMap(e=>e.patches).filter(e=>null==e.contents||null==e.files||null==e.repository);for(let t of(await Promise.allSettled(e.map(e=>this.container.drafts.getPatchDetails(e)))))if("fulfilled"===t.status){let i=e.find(e=>e.id===t.value.id);null!=i&&(i.contents=t.value.contents,i.files=t.value.files,i.repository=t.value.repository)}this.notifyDidChangeViewDraftState()},0);let e=this._context.draftUserState;return{draftType:"cloud",id:t.id,createdAt:t.createdAt.getTime(),updatedAt:t.updatedAt.getTime(),author:t.author,role:t.role,title:t.title,description:t.description,visibility:t.visibility,patches:(0,k.q)(t.changesets[0].patches.map(e=>({...e,contents:void 0,commit:void 0,repository:{id:e.gkRepositoryId,name:e.repository?.name??"",located:null!=e.repository&&(0,d.uC)(e.repository)}}))),users:e.users,userSelections:e.selections}}}async createDraftUserState(e,t){if(null==this._context.draftUserState||t?.force===!0)try{let t=await this.container.drafts.getDraftUsers(e.id);if(0===t.length)return;let i=[],s=[],a=await this.getOrganizationMembers();for(let e of t){i.push(e);let t=a.find(t=>t.id===e.userId);s.push(ee(t,e))}this._context.draftUserState={users:i,selections:s}}catch(e){}}async notifyDidChangeViewDraftState(){return this.host.notify(Q,{mode:this._context.mode,draft:(0,k.q)(await this.getViewDraftState(this._context))})}updatePreferences(e){(this._context.preferences?.files?.compact!==e.files?.compact||this._context.preferences?.files?.icon!==e.files?.icon||this._context.preferences?.files?.layout!==e.files?.layout||this._context.preferences?.files?.threshold!==e.files?.threshold)&&(null!=e.files&&(this._context.preferences?.files?.compact!==e.files?.compact&&w.D.updateEffective("views.patchDetails.files.compact",e.files?.compact),this._context.preferences?.files?.icon!==e.files?.icon&&w.D.updateEffective("views.patchDetails.files.icon",e.files?.icon),this._context.preferences?.files?.layout!==e.files?.layout&&w.D.updateEffective("views.patchDetails.files.layout",e.files?.layout),this._context.preferences?.files?.threshold!==e.files?.threshold&&w.D.updateEffective("views.patchDetails.files.threshold",e.files?.threshold),this._context.preferences.files=e.files),this.notifyDidChangePreferences())}async notifyDidChangePreferences(){return this.host.notify(Y,{preferences:this._context.preferences})}async getDraftPatch(e,t){if(null==e.changesets){let t=await this.container.drafts.getChangesets(e.id);e.changesets=t}let i=null==t?e.changesets[0].patches?.[0]:e.changesets[0].patches?.find(e=>e.gkRepositoryId===t);if(null!=i){if(null==i.contents||null==i.files||null==i.repository){let e=await this.container.drafts.getPatchDetails(i.id);i.contents=e.contents,i.files=e.files,i.repository=e.repository}return i}}async getFileCommitFromParams(e){let[t,i]=await this.getOrCreateCommit(e);return null!=t&&null!=i?[t,new h.K8(e.repoPath,e.path,e.status,e.originalPath,void 0,void 0,e.staged),i]:null!=(t=await t?.getCommitForFile(e.path,e.staged))?[t,t.file,i]:void 0}async getOrCreateCommit(e){switch(this.mode){case"create":return this.getCommitForFile(e);case"view":return[await this.getOrCreateCommitForPatch(e.gkRepositoryId)];default:return[void 0]}}async getCommitForFile(e){let t=(0,b.sE)(this._context.create.changes.values(),t=>t.repository.path===e.repoPath);if(null==t)return[void 0];let i=await t.getChange();if(null==i)return[void 0];if("revision"===i.type){let t=await this.container.git.getCommit(e.repoPath,i.revision.to??c.CL);return i.revision.to===i.revision.from||i.revision.from.length===i.revision.to.length+1&&i.revision.from.endsWith("^")&&i.revision.from.startsWith(i.revision.to)?[t]:[t,i.revision]}return"wip"===i.type?[await this.container.git.getCommit(e.repoPath,i.revision.to??c.CL)]:[void 0]}async getOrCreateCommitForPatch(e){let t=this._context.draft;if("local"===t.draftType)return;let i=await this.getDraftPatch(t,e);if(i?.repository!=null){if(i?.commit==null){if(!(0,d.uC)(i.repository)){let e=await this.container.repositoryIdentity.getRepository(i.repository,{openIfNeeded:!0,prompt:!0});if(null==e){s.window.showErrorMessage(`Unable to locate repository '${i.repository.name}'`);return}i.repository=e}try{let e=await this.container.git.createUnreachableCommitForPatch(i.repository.uri,i.contents,i.baseRef??"HEAD",t.title);i.commit=e}catch(e){s.window.showErrorMessage(`Unable preview the patch on base '${i.baseRef}': ${e.message}`),i.baseRef=void 0}}return i?.commit}}async openFile(e){let t=await this.getFileCommitFromParams(e);if(null==t)return;let[i,s]=t;(0,n.ZB)(s,i,{preserveFocus:!0,preview:!0,...e.showOptions})}async openFileComparisonWithPrevious(e){let t=await this.getFileCommitFromParams(e);if(null==t)return;let[i,s,a]=t;(0,n.vw)(s,null!=a?{repoPath:i.repoPath,rhs:a.to??c.CL,lhs:a.from}:i,{preserveFocus:!0,preview:!0,...e.showOptions,rhsTitle:"view"===this.mode?`${(0,x.EZ)(s.path)} (Patch)`:void 0}),this.container.events.fire("file:selected",{uri:s.uri},{source:this.host.id})}async openFileComparisonWithWorking(e){let t=await this.getFileCommitFromParams(e);if(null==t)return;let[i,s,a]=t;(0,n.ce)(s,null!=a?{repoPath:i.repoPath,ref:a.to}:i,{preserveFocus:!0,preview:!0,...e.showOptions,lhsTitle:"view"===this.mode?`${(0,x.EZ)(s.path)} (Patch)`:void 0})}};function ee(e,t,i,s){return{change:s,member:e,user:t,pendingRole:i,avatarUrl:e?.email!=null?(0,a.oP)(e.email,void 0).toString():void 0}}((e,t,i,s)=>{for(var a,r=s>1?void 0:s?X(t,i):t,o=e.length-1;o>=0;o--)(a=e[o])&&(r=(s?a(t,i,r):a(r))||r);return s&&r&&K(t,i,r)})([(0,C.fF)({args:!1})],PatchDetailsWebviewProvider.prototype,"getState",1)},7387:(e,t,i)=>{i.d(t,{q:()=>s});function s(e){if(null!=e)try{return JSON.parse(JSON.stringify(e,function(e,t){if(t instanceof Date)return t.getTime();if(t instanceof Map||t instanceof Set)return[...t.entries()];if(t instanceof Function||t instanceof Error)return;if(t instanceof RegExp)return t.toString();let i=this[e];return i instanceof Date?i.getTime():t}))}catch(e){throw e}}}};