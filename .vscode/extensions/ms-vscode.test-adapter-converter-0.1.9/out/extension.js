"use strict";var D=Object.create;var v=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var H=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty;var L=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports),_=(o,e)=>{for(var t in e)v(o,t,{get:e[t],enumerable:!0})},R=(o,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of U(e))!F.call(o,r)&&r!==t&&v(o,r,{get:()=>e[r],enumerable:!(s=P(e,r))||s.enumerable});return o};var f=(o,e,t)=>(t=o!=null?D(H(o)):{},R(e||!o||!o.__esModule?v(t,"default",{value:o,enumerable:!0}):t,o)),O=o=>R(v({},"__esModule",{value:!0}),o);var S=L(g=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});g.testExplorerExtensionId=void 0;g.testExplorerExtensionId="hbenl.vscode-test-explorer"});var G={};_(G,{activate:()=>V});module.exports=O(G);var d=f(require("vscode")),x=f(S());var p=f(require("vscode")),k="promptedToUseNative",B=!1,I="testExplorer.useNativeTesting",C=()=>!!p.workspace.getConfiguration().get(I,!1),T=(o=p.ConfigurationTarget.Global)=>{p.workspace.getConfiguration().update(I,!0,o),p.window.showInformationMessage('Thanks for taking native testing for a spin! If you run into problems, you can turn the new experience off with the "testExplorer.useNativeTesting" setting.')};var m=class{constructor(e){this.context=e}registerTestAdapter(e){this.shouldPrompt()&&e.testStates(t=>{t.type==="started"&&this.promptToUseNativeTesting()})}unregisterTestAdapter(){}shouldPrompt(){return!B&&!C()&&!this.context.globalState.get(k)}async promptToUseNativeTesting(){if(!this.shouldPrompt())return;let e="Yes",t="Only in this Workspace",s="No";B=!0;let r=await p.window.showInformationMessage("Would you like to try out VS Code's new native UI for testing?",s,e,t);r&&(r===e?T(p.ConfigurationTarget.Global):r===t?T(p.ConfigurationTarget.Workspace):r===s&&this.context.globalState.update(k,!0))}};var N=f(require("vscode"));var i=f(require("vscode")),b=new WeakMap,W=(o,e)=>{let t=new Set;return o.filter(s=>{let r=e(s);return t.has(r)?!1:(t.add(r),!0)})},$="workbench.view.extension.test",j=1,y=class{constructor(e){this.adapter=e;this.itemsById=new Map;this.tasksByRunId=new Map;this.runningSuiteByRunId=new Map;this.disposables=[];this.controller=i.tests.createTestController(`test-adapter-ctrl-${j++}`,""),this.controller.refreshHandler=()=>this.adapter.load(),this.disposables.push(this.controller);let t=s=>(r,n)=>{if(!r.include){this.run(this.controller.createTestRun(r),r.include,s,n);return}let a=new Map;for(let c of r.include){let u=b.get(c).converter,l=a.get(u);l?l.push(c):a.set(u,[c])}for(let[c,u]of a)c.run(this.controller.createTestRun(r),u,s,n)};this.controller.createRunProfile("Run",i.TestRunProfileKind.Run,t(!1),!0),this.controller.createRunProfile("Debug",i.TestRunProfileKind.Debug,t(!0),!0),this.disposables.push(e.tests(s=>{var r;switch(s.type){case"finished":(r=this.doneDiscovery)==null||r.call(this),this.doneDiscovery=void 0,this.itemsById.clear(),this.syncTopLevel(s);break;case"started":this.doneDiscovery||i.window.withProgress({title:"An adapter is discovering tests",location:{viewId:$}},()=>new Promise(n=>{this.doneDiscovery=n,setTimeout(n,3e4)}));break}}),e.testStates(s=>{var n,a;let r=this.tasksByRunId.get((n=s.testRunId)!=null?n:"");if(r)switch(s.type){case"test":return this.onTestEvent(r,s);case"suite":return this.onTestSuiteEvent(s);case"finished":return this.tasksByRunId.delete((a=s.testRunId)!=null?a:""),r.end()}}))}get error(){return this._error}get controllerId(){return this.controller.id}dispose(){this.disposables.forEach(e=>e.dispose())}async run(e,t,s,r){if(!this.controller)return;t||(t=M(this.controller.items));let n=this.adapter.testStates(a=>{var u,l;if(a.type!=="started")return;let c=[t];for(;c.length;)for(let h of c.pop())(u=b.get(h))!=null&&u.isSuite||e.enqueued(h),c.push(M(h.children));this.tasksByRunId.set((l=a.testRunId)!=null?l:"",e),r.onCancellationRequested(()=>this.adapter.cancel()),n.dispose()});s?this.adapter.debug?this.adapter.debug(t.map(a=>a.id)):n.dispose():this.adapter.run(t.map(a=>a.id))}syncTopLevel(e){var t;if(i.commands.executeCommand("setContext","hasTestConverterTests",!0),e.suite)this.controller.label=this.adapter.workspaceFolder?`${this.adapter.workspaceFolder.name} - ${e.suite.label}`:e.suite.label,this.syncItemChildren(this.controller.items,e.suite.children);else if(e.errorMessage){let s=this.controller.createTestItem("error","Test discovery failed");this._error=e.errorMessage+`


`+((t=new Error().stack)==null?void 0:t.replace("Error:","Stacktrace:")),s.error=new i.MarkdownString(`[View details](command:testExplorerConverter.showError?${encodeURIComponent(JSON.stringify([this.controllerId]))})`),s.error.isTrusted=!0,this.controller.items.replace([s])}}syncItemChildren(e,t,s){e.replace(W(t,r=>r.id).map(r=>this.createTest(r,s)))}createTest(e,t){let s=this.controller.createTestItem(e.id,e.label,e.file?A(e.file):t);return b.set(s,{isSuite:e.type==="suite",converter:this}),this.itemsById.set(e.id,s),s.description=e.description,e.line!==void 0&&(s.range=new i.Range(e.line,0,e.line+1,0)),e.errored&&(s.error=e.message),"children"in e&&this.syncItemChildren(s.children,e.children),s}onTestSuiteEvent(e){var n;let t=(n=e.testRunId)!=null?n:"",s=this.runningSuiteByRunId.get(t),r=typeof e.suite=="string"?e.suite:e.suite.id;e.state==="running"?(!this.itemsById.has(r)&&typeof e.suite=="object"&&s&&s.children.add(this.createTest(e.suite)),this.itemsById.has(r)&&this.runningSuiteByRunId.set(t,this.itemsById.get(r))):s&&s.id===r&&(s.parent?this.runningSuiteByRunId.set(t,s.parent):this.runningSuiteByRunId.delete(t))}onTestEvent(e,t){var a,c;let s=this.runningSuiteByRunId.get((a=t.testRunId)!=null?a:""),r=typeof t.test=="string"?t.test:t.test.id;t.state==="running"&&!this.itemsById.has(r)&&typeof t.test=="object"&&s&&s.children.add(this.createTest(t.test));let n=this.itemsById.get(r);if(n){switch(t.state){case"skipped":e.skipped(n);break;case"running":e.started(n);break;case"passed":e.passed(n);break;case"errored":case"failed":let u=[];if(t.message){let l=new i.TestMessage(t.message);u.push(l)}for(let l of(c=t.decorations)!=null?c:[]){let h=new i.TestMessage(l.message),E=l.file?A(l.file):n.uri;E&&(h.location=new i.Location(E,new i.Position(l.line,0))),u.push(h)}e[t.state](n,u);break}t.message&&(t.state!=="errored"&&t.state!=="failed"||!n.uri)&&e.appendOutput(t.message.replace(/\r?\n/g,`\r
`))}}},M=o=>{let e=[];return o.forEach(t=>e.push(t)),e},K=/^[a-z][a-z0-9+-.]+:/,A=o=>K.test(o)?i.Uri.parse(o):i.Uri.file(o);var w=class{constructor(){this.converters=new Map}registerTestAdapter(e){this.converters.set(e,new y(e))}unregisterTestAdapter(e){var t;(t=this.converters.get(e))==null||t.dispose(),this.converters.delete(e)}getByControllerId(e){for(let t of this.converters.values())if(t.controllerId===e)return t}dispose(){for(let e of this.converters.values())e.dispose();N.commands.executeCommand("setContext","hasTestConverterTests",!1)}};function V(o){let e,t=new m(o);d.env.appName.toLowerCase().includes("insiders")&&t.shouldPrompt()&&setTimeout(()=>{var r;let s=(r=d.extensions.getExtension(x.testExplorerExtensionId))==null?void 0:r.exports;s&&(s.registerTestController(t),o.subscriptions.push({dispose(){s.unregisterTestController(t)}}))},2e3),o.subscriptions.push(d.commands.registerCommand("testExplorerConverter.activate",()=>{var r;let s=(r=d.extensions.getExtension(x.testExplorerExtensionId))==null?void 0:r.exports;s&&(e=new w,o.subscriptions.push(e),s.registerTestController(e),o.subscriptions.push({dispose(){s.unregisterTestController(e)}}))}),d.workspace.onDidChangeConfiguration(s=>{s.affectsConfiguration(I)&&(C()||(e==null||e.dispose(),e=void 0))}),d.commands.registerCommand("testExplorerConverter.useNativeTesting",()=>T()),d.commands.registerCommand("testExplorerConverter.showError",s=>{var n;let r=(n=e==null?void 0:e.getByControllerId(s))==null?void 0:n.error;r&&z(r)}))}var z=async o=>{let e=await d.workspace.openTextDocument({content:o});await d.window.showTextDocument(e)};0&&(module.exports={activate});
